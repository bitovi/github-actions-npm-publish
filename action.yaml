name: 'npm Version and Publish'
author: Bitovi
description: 'Version and publish your npm package'
branding:
  icon: tag
  color: red
inputs:
  checkout:
    description: Checkout the repository
    required: false
    default: 'true'
  node_version:
    description: Node version
    required: false
    default: '20'
  node_command:
    description: Node command to be executed after setting up node.
    required: false
    default: 'npm i'
  update_type:
    description: "The version segment to increment: major, minor, or patch."
    required: true
    default: 'patch'
  publish:
    description: "Publish the package"
    required: false
    default: 'true'
  npm_token:
    description: "npm Secrets token"
    required: true
  git_user_name:
    description: "Git username for commits"
    required: false
    default: 'Bitovi Automation'
  git_user_email:
    description: "Git email for commits"
    required: false
    default: 'os@bitovi.com'

runs:
  using: "composite"
  steps:
    - name: Setup npm authentication
      shell: bash
      run: |
        echo "//registry.npmjs.org/:_authToken=${{ inputs.npm_token }}" > ~/.npmrc
        npm whoami || echo "npm login check failed - continuing anyway"
    - name: Checkout if required
      if: ${{ inputs.checkout == 'true' }}
      uses: actions/checkout@v4

    - name: Setup node
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node_version }}
          
    - id: Tag-push
      shell: bash
      run: |
        ${{ inputs.node_command }}
        git init
        git config user.name "${{ inputs.git_user_name }}"
        git config user.email "${{ inputs.git_user_email }}"
        npm version ${{ inputs.update_type }} -m "Publish v%s"
        # git push --tags

    - name: Publish to NPM Registry
      if: ${{ inputs.publish == 'true' }}
      uses: JS-DevTools/npm-publish@v3
      with:
        token: ${{ inputs.npm_token }}
